<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Post</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin_post_view.css">
    <link rel="stylesheet" href="/admin/css/shared_rules.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="admin_users.html"><i class="fas fa-users"></i> Manage Users</a></li>
            <li><a href="admin_posts.html" class="active"><i class="fas fa-file-alt"></i> Manage Posts</a></li>
            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-section">
            <h1>View Post</h1>
            <div class="tools">
                <a href="admin_posts.html" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Posts
                </a>
            </div>
        </div>

        <div id="message" class="message" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner"></i> Loading post...
        </div>

        <div id="postContainer" class="post-container" style="display: none;">
            <h2 id="postTitle" class="post-title"></h2>
            <img id="postImage" class="post-image" src="" alt="Post image">
            <div id="postContent" class="post-content"></div>
            <div id="postMeta" class="author-info">
                <img id="authorPhoto" class="author-img" src="" alt="Author's photo">
                <div class="author-details">
                    <div id="authorName" class="author-name"></div>
                    <div id="createdAt" class="author-date"></div>
                </div>
            </div>
            <div class="post-actions">
                <button id="viewCommentsBtn" class="btn btn-primary"><i class="fas fa-comments"></i> View Comments</button>
                <button id="editPostBtn" class="btn btn-warning"><i class="fas fa-edit"></i> Edit Post</button>
                <button id="deletePostBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Delete Post</button>
            </div>
        </div>
    </div>

    <div id="viewCommentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewCommentsModalTitle"><i class="fas fa-comments"></i> Post Comments</h2>
                <button type="button" class="close-btn" data-modal-id="viewCommentsModal">×</button>
            </div>
            <div class="modal-body" id="viewCommentsModalBody">
                <div class="add-comment-section">
                    <h3><i class="fas fa-comment-medical"></i> Add New Comment</h3>
                    <form id="addCommentForm" class="add-comment-form">
                        <input type="hidden" id="addCommentPostId" value="">
                        <div>
                            <label for="addCommentUserId">User ID <span style="color: red">*</span></label>
                            <input type="text" id="addCommentUserId" placeholder="Enter user ID" required>
                        </div>
                        <div>
                            <label for="addCommentContent">Comment <span style="color: red">*</span></label>
                            <textarea id="addCommentContent" placeholder="Write your comment here..." required></textarea>
                        </div>
                        <p id="addCommentError" class="form-error"></p>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Comment</button>
                    </form>
                </div>
                <div id="modalLoading" class="loading-modal" style="display: none;">
                    <i class="fas fa-spinner"></i> Loading comments...
                </div>
                <div id="modalNoComments" class="no-data-modal" style="display: none;">
                    <p>No comments for this post.</p>
                </div>
                <table id="modalCommentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="150">Author</th>
                            <th>Comment</th>
                            <th>Created Date</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="modalCommentsTbody"></tbody>
                </table>
                <div id="modalPagination" class="modal-pagination"></div>
            </div>
        </div>
    </div>

    <div id="editCommentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Comment</h2>
                <button type="button" class="close-btn" data-modal-id="editCommentModal">×</button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <input type="hidden" id="editCommentId">
                    <input type="hidden" id="editCommentPostId">
                    <div>
                        <label for="editContent">Comment Content <span style="color: red">*</span></label>
                        <textarea id="editContent" rows="5" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                        <button type="button" class="btn btn-secondary close-btn" data-modal-id="editCommentModal"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Ensure user is authenticated
        redirectToLoginIfNotAuthenticated();

        // Main Interface Elements
        const postContainer = document.getElementById('postContainer');
        const postTitle = document.getElementById('postTitle');
        const postImage = document.getElementById('postImage');
        const postContent = document.getElementById('postContent');
        const authorPhoto = document.getElementById('authorPhoto');
        const authorName = document.getElementById('authorName');
        const createdAt = document.getElementById('createdAt');
        const postMeta = document.getElementById('postMeta');
        const viewCommentsBtn = document.getElementById('viewCommentsBtn');
        const editPostBtn = document.getElementById('editPostBtn');
        const deletePostBtn = document.getElementById('deletePostBtn');
        const messageDiv = document.getElementById('message');
        const loadingDiv = document.getElementById('loading');
        const logoutBtn = document.getElementById('logoutBtn');

        // View Comments Modal Elements
        const viewCommentsModal = document.getElementById('viewCommentsModal');
        const viewCommentsModalTitle = document.getElementById('viewCommentsModalTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalNoComments = document.getElementById('modalNoComments');
        const modalCommentsTable = document.getElementById('modalCommentsTable');
        const modalCommentsTbody = document.getElementById('modalCommentsTbody');
        const modalPaginationDiv = document.getElementById('modalPagination');

        // Add Comment Form Elements
        const addCommentForm = document.getElementById('addCommentForm');
        const addCommentPostIdInput = document.getElementById('addCommentPostId');
        const addCommentUserIdInput = document.getElementById('addCommentUserId');
        const addCommentContentInput = document.getElementById('addCommentContent');
        const addCommentError = document.getElementById('addCommentError');

        // Edit Comment Modal Elements
        const editCommentModal = document.getElementById('editCommentModal');
        const editCommentForm = document.getElementById('editCommentForm');
        const editCommentIdInput = document.getElementById('editCommentId');
        const editCommentPostIdInput = document.getElementById('editCommentPostId');
        const editContentInput = document.getElementById('editContent');

        // State Variables
        let postId = null;
        let currentModalCommentsPage = 1;
        const modalCommentsPerPage = 5;

        // Helper Functions
        function showMessage(id, text, type = 'success') {
            const div = document.getElementById(id);
            div.className = 'message ' + type;
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            div.innerHTML = icon + text;
            div.style.display = 'flex';
            setTimeout(() => {
                div.style.display = 'none';
            }, 5000);
        }

        function hideMessage(id) {
            document.getElementById(id).style.display = 'none';
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not available';
            try {
                return new Date(dateString).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Load Post Details
        async function loadPostDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get('id');
        
            if (!postId) {
                showMessage('message', 'Post ID not specified.', 'error');
                loadingDiv.style.display = 'none';
                return;
            }
        
            loadingDiv.style.display = 'flex';
            postContainer.style.display = 'none';
        
            const result = await apiGetPostDetails(postId);
            loadingDiv.style.display = 'none';
        
            if (result.ok && result.data) {
                const post = result.data.post || result.data;
                postTitle.textContent = escapeHtml(post.title) || 'No title';
                postImage.src = post.image || 'https://via.placeholder.com/600x400?text=No+Image';
        
                // Split content into paragraphs based on line breaks
                const paragraphs = (post.content || 'No content').split('\n').filter(p => p.trim());
                postContent.innerHTML = paragraphs
                    .map(paragraph => `<p>${escapeHtml(paragraph)}</p>`)
                    .join('');
        
                if (post.author) {
                    const fullName = `${post.author.first_name || ''} ${post.author.last_name || ''}`.trim();
                    authorName.textContent = fullName || 'Unknown';
                    authorPhoto.src = post.author.photo || 'https://via.placeholder.com/50?text=User';
                } else {
                    authorName.textContent = 'Unknown';
                    authorPhoto.style.display = 'none';
                }
        
                createdAt.textContent = formatDate(post.created_at);
                postMeta.style.display = 'block';
                postContainer.style.display = 'block';
        
                // Set button actions
                viewCommentsBtn.onclick = () => openViewCommentsModal(post.id);
                editPostBtn.onclick = () => window.location.href = `admin_post_edit.html?id=${post.id}`;
                deletePostBtn.onclick = () => deletePost(post.id, post.title);
            } else {
                showMessage('message', `Failed to load post details: ${result.error || 'An error occurred while loading the data.'}`, 'error');
                postContainer.style.display = 'none';
            }
        }

        // Delete Post
        async function deletePost(postId, postTitle) {
            if (confirm(`Are you sure you want to delete the post "${postTitle}"?`)) {
                loadingDiv.style.display = 'flex';
                postContainer.style.display = 'none';
                const result = await apiDeletePost(postId);
                loadingDiv.style.display = 'none';
                if (result.ok) {
                    showMessage('message', `Post "${postTitle}" deleted successfully`, 'success');
                    setTimeout(() => {
                        window.location.href = 'admin_posts.html';
                    }, 2000);
                } else {
                    showMessage('message', `Failed to delete post: ${result.error || 'Unknown error'}`, 'error');
                    postContainer.style.display = 'block';
                }
            }
        }

        // Comments Modal Functions
        function openViewCommentsModal(postId) {
            currentModalCommentsPage = 1;
            viewCommentsModalTitle.innerHTML = `<i class="fas fa-comments"></i> Post Comments #${postId}`;
            addCommentPostIdInput.value = postId;
            addCommentUserIdInput.value = '';
            addCommentContentInput.value = '';
            addCommentError.style.display = 'none';
            modalLoading.style.display = 'flex';
            modalCommentsTable.style.display = 'none';
            modalNoComments.style.display = 'none';
            modalCommentsTbody.innerHTML = '';
            modalPaginationDiv.innerHTML = '';
            viewCommentsModal.style.display = 'block';
            loadPostCommentsForModal(postId, 1);
        }

        async function loadPostCommentsForModal(postId, page) {
            modalLoading.style.display = 'flex';
            modalCommentsTable.style.display = 'none';
            modalNoComments.style.display = 'none';
            currentModalCommentsPage = page;

            const result = await apiAdminGetPostComments(postId, page, modalCommentsPerPage);

            modalLoading.style.display = 'none';

            if (result.ok && result.data.comments) {
                renderPostCommentsInModal(result.data.comments);
                const totalPages = result.data.pages || Math.ceil(result.data.total / modalCommentsPerPage);
                renderModalPagination(postId, result.data.page, totalPages);
            } else {
                modalCommentsTbody.innerHTML = '';
                modalNoComments.innerHTML = `<p class="text-danger">Failed to load comments: ${result.error || 'Unknown error'}</p>`;
                modalNoComments.style.display = 'block';
                modalPaginationDiv.innerHTML = '';
            }
        }

        function renderPostCommentsInModal(comments) {
            modalCommentsTbody.innerHTML = '';

            if (comments.length > 0) {
                modalCommentsTable.style.display = 'table';
                modalNoComments.style.display = 'none';

                comments.forEach(comment => {
                    const row = modalCommentsTbody.insertRow();
                    const author = comment.author || {};
                    const photoHtml = author.photo
                        ? `<img src="${escapeHtml(author.photo)}" alt="Author's photo" class="author-img-sm">`
                        : `<span style="display:inline-block;width:30px;height:30px;line-height:30px;text-align:center;background:#eee;border-radius:50%;font-size:14px;vertical-align:middle;margin-right:5px;"><i class="fas fa-user"></i></span>`;

                    row.innerHTML = `
                        <td>
                            ${photoHtml}
                            <span>${escapeHtml(author.first_name || '')} ${escapeHtml(author.last_name || '(Unknown)')}</span>
                        </td>
                        <td class="comment-content">${escapeHtml(comment.content) || ''}</td>
                        <td>${formatDate(comment.created_at)}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit modal-edit-comment-btn" data-comment-id="${comment.id}" data-comment-content="${escapeHtml(comment.content)}" title="Edit Comment">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete modal-delete-comment-btn" data-comment-id="${comment.id}" title="Delete Comment">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.modal-edit-comment-btn').addEventListener('click', handleModalEditClick);
                    row.querySelector('.modal-delete-comment-btn').addEventListener('click', handleModalDeleteClick);
                });
            } else {
                modalCommentsTable.style.display = 'none';
                modalNoComments.innerHTML = '<p>No comments for this post.</p>';
                modalNoComments.style.display = 'block';
            }
        }

        function renderModalPagination(postId, currentPage, totalPages) {
            modalPaginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.title = 'Previous Page';
            prevButton.onclick = () => loadPostCommentsForModal(postId, currentPage - 1);
            modalPaginationDiv.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            modalPaginationDiv.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage >= totalPages;
            nextButton.title = 'Next Page';
            nextButton.onclick = () => loadPostCommentsForModal(postId, currentPage + 1);
            modalPaginationDiv.appendChild(nextButton);
        }

        // Handle Add Comment Form Submission
        addCommentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = addCommentPostIdInput.value;
            const userId = addCommentUserIdInput.value.trim();
            const content = addCommentContentInput.value.trim();

            if (!userId) {
                addCommentError.textContent = 'User ID cannot be empty.';
                addCommentError.style.display = 'block';
                return;
            }

            if (!content) {
                addCommentError.textContent = 'Comment content cannot be empty.';
                addCommentError.style.display = 'block';
                return;
            }

            addCommentError.style.display = 'none';

            const submitButton = addCommentForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner"></i> Submitting...';

            const commentData = {
                content: content,
                user_id: userId
            };

            const result = await apiAdminCreateComment(postId, commentData);

            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;

            if (result.ok) {
                showMessage('message', 'Comment added successfully.', 'success');
                addCommentUserIdInput.value = '';
                addCommentContentInput.value = '';
                loadPostCommentsForModal(postId, 1);
            } else {
                addCommentError.textContent = `Failed to add comment: ${result.error || 'Unknown error'}`;
                addCommentError.style.display = 'block';
            }
        });

        // Handle Edit Comment Button Click
        function handleModalEditClick(event) {
            const button = event.currentTarget;
            const commentId = button.dataset.commentId;
            const content = button.dataset.commentContent;

            editCommentIdInput.value = commentId;
            editContentInput.value = content;
            editCommentPostIdInput.value = postId;
            editCommentModal.style.display = 'block';
        }

        // Handle Edit Comment Form Submission
        editCommentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentId = editCommentIdInput.value;
            const postId = editCommentPostIdInput.value;
            const content = editContentInput.value.trim();

            if (!content) {
                addCommentError.textContent = 'Comment content cannot be empty.';
                addCommentError.style.display = 'block';
                return;
            }

            const commentData = { content: content };
            const submitButton = editCommentForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner"></i> Saving...';

            const result = await apiAdminUpdateComment(commentId, commentData);

            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;

            if (result.ok) {
                closeModal('editCommentModal');
                showMessage('message', 'Comment updated successfully.', 'success');
                if (postId) {
                    loadPostCommentsForModal(postId, currentModalCommentsPage);
                }
            } else {
                addCommentError.textContent = `Failed to update comment: ${result.error || 'Unknown error'}`;
                addCommentError.style.display = 'block';
            }
        });

        // Handle Delete Comment Button Click
        async function handleModalDeleteClick(event) {
            const button = event.currentTarget;
            const commentId = button.dataset.commentId;

            if (confirm(`Are you sure you want to delete comment #${commentId}?`)) {
                const result = await apiAdminDeleteComment(commentId);

                if (result.ok) {
                    showMessage('message', `Comment ${commentId} deleted successfully.`, 'success');
                    if (postId) {
                        const currentCommentRows = modalCommentsTbody.rows.length - 1;
                        if (currentCommentRows === 0 && currentModalCommentsPage > 1) {
                            loadPostCommentsForModal(postId, currentModalCommentsPage - 1);
                        } else {
                            loadPostCommentsForModal(postId, currentModalCommentsPage);
                        }
                    }
                } else {
                    showMessage('message', `Failed to delete comment: ${result.error || 'Unknown error'}`, 'error');
                }
            }
        }

        // Close Modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Add Event Listeners for Close Buttons
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.currentTarget.dataset.modalId;
                if (modalId) {
                    closeModal(modalId);
                }
            });
        });

        // Close Modal on Outside Click
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        });

        // Logout
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to log out?')) {
                logout();
            }
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', loadPostDetails);
    </script>
</body>
</html>